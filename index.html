<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <link href="data:image/x-icon;" rel="icon" />
    <title>LineageOS Devices Table</title>
    <style>

      body {
        color: #fff;
        background-color: #111;
      }

      #loadingBox {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid white;
        height: 20%;
        width: 20%;
      }

      #textBox {      
        position: absolute;
        left: 50%;
        transform: translate(-50%, 0%);
        top: 10%;
        height: 50%;
        width: 90%;
        color: white;
        margin: auto;
      }

      #textLine {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-size: 1vw;
        font-family: monospace;
        text-align: center;
      }

      #progressBox {
        position: absolute;
        left: 50%;
        transform: translate(-50%, 0%);
        bottom: 10%;
        height: 10%;
        width: 90%;
        border: 1px solid white;
      }

      #progressComplete {
        height: 100%;
        width: 0%;
        left: 0;
        background-color: white;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        display: none;
      }

      th, td {
        padding: 8px;
        text-align: left;
        border: 1px solid;
      }

      thead th {
        position: sticky;
        top: 0px;
        background-color: #111;
      }

      tbody tr:hover {
        background-color: #444;
      }

    </style>
  </head>
  <body>

    <div id="loadingBox">
      <div id="textBox">
        <div id="textLine"></div>          
      </div>
      <div id="progressBox">
        <div id="progressComplete"></div>          
      </div>
    </div>
    <div id="tableDiv">
     <table id="table">
       <thead id='thead'></thead>
       <tbody id='tbody'></tbody>
     </table> 
    </div>

    <script type="module">
      import YAML from 'https://cdn.jsdelivr.net/npm/yaml@2.3.0/+esm' 
      window.YAML = YAML;
    </script>
    <script>
      (async () => {

        const textLine = document.getElementById("textLine");
        const progress = document.getElementById("progressComplete");
        const loadingBox = document.getElementById("loadingBox");
        const table = document.getElementById("table");
        const thead = table.getElementsByTagName('thead')[0];
        const tbody = table.getElementsByTagName('tbody')[0];

        if (window.localStorage.getItem("activeModels") === null) {
          const r = await fetch("https://download.lineageos.org/api/v2/oems");
          const rr = await r.json();
          window.localStorage.setItem("activeModels", JSON.stringify(rr.flatMap(b=>b.devices).map(m=>m.model)));
        }
        const activeModels = JSON.parse(window.localStorage.getItem("activeModels"))

        if (window.localStorage.getItem("yamlFiles") === null) {
          const r = await fetch("https://api.github.com/repositories/79186428/contents/_data/devices");
          const rr = await r.json();
          window.localStorage.setItem("yamlFiles", JSON.stringify(rr.map(x=>x.name)));
        }
        const allYamls = JSON.parse(window.localStorage.getItem("yamlFiles"))

        let data;
        if (window.localStorage.getItem("data") === null) {
          data = {};
          window.localStorage.setItem("data", JSON.stringify(data));
        } else {
          data = JSON.parse(window.localStorage.getItem("data"));
        }

        const activeYamls = []
        for (let i=0; i < activeModels.length; i++) {
          let d = activeModels[i];
          if (allYamls.includes(`${d}.yml`)) {
            activeYamls.push(d);
          } else {
            for (let m of allYamls.filter(x=>x.match(new RegExp(`^${d}_variant[0-9].yml`)))) {
              activeYamls.push(m.replace(/\.yml$/, ''));
            }
          }
        }

        let c = 0
        for (let d of activeYamls) {
          c++;
          textLine.innerHTML = d;
          if (!(d in data)) {
            const r = await fetch(`https://raw.githubusercontent.com/LineageOS/lineage_wiki/master/_data/devices/${d}.yml`);
            const rr = await r.text();
            data = JSON.parse(window.localStorage.getItem("data"));
            data[d] = YAML.parse(rr);
            window.localStorage.setItem("data", JSON.stringify(data));
          }
          progress.style.width = `${(c / activeYamls.length).toFixed(2) * 100}%`;
        } 
        data = JSON.parse(window.localStorage.getItem("data"));
        
        const headings = Object.keys(data[Object.keys(data)[0]])
        const hr = document.createElement('tr')
        for (const h of headings) {
          hr.innerHTML += `<th>${h}</th>`
        }
        thead.appendChild(hr);

        let br;
        for (const d of Object.values(data)) {
          br = document.createElement('tr')
          for (let h of headings) {
            const v = d[h] 
            if (typeof v === 'string') {
              br.innerHTML += `<td>${v}</td>`
            } else {
              br.innerHTML += `<td>_FILLER_</td>`
            }
          }
          tbody.appendChild(br);
        }


        loadingBox.style.display = 'none';
        table.style.display = 'block';
        
        

      })()
    </script>
  </body>
</html>
