<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <link href="data:image/x-icon;" rel="icon" />
    <title>LineageOS Devices Table</title>
    <style>
      body {
        color: #fff;
        background-color: #111;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import YAML from 'https://cdn.jsdelivr.net/npm/yaml@2.3.0/+esm' 
      window.YAML = YAML;
    </script>
    <script>
      (async () => {

        if (window.localStorage.getItem("activeModels") === null) {
          const r = await fetch("https://download.lineageos.org/api/v2/oems");
          const rr = await r.json();
          window.localStorage.setItem("activeModels", JSON.stringify(rr.flatMap(b=>b.devices).map(m=>m.model)));
        }
        const activeModels = JSON.parse(window.localStorage.getItem("activeModels"))

        if (window.localStorage.getItem("yamlFiles") === null) {
          const r = await fetch("https://api.github.com/repositories/79186428/contents/_data/devices");
          const rr = await r.json();
          window.localStorage.setItem("yamlFiles", JSON.stringify(rr.map(x=>x.name)));
        }
        const allModels = JSON.parse(window.localStorage.getItem("yamlFiles"))
        window.am = allModels

        let data;
        if (window.localStorage.getItem("data") === null) {
          data = {};
          window.localStorage.setItem("data", JSON.stringify(data));
        } else {
          data = JSON.parse(window.localStorage.getItem("data"));
        }


        //for (let i=0; i < rr.length; i++) { console.log(rr[i]); if (i===3) rr.push(88);}
        
        for (let d of activeModels) {
          if (!(d in data)) {
            if (allModels.includes(`${d}.yml`)) {
              const r = await fetch(`https://raw.githubusercontent.com/LineageOS/lineage_wiki/master/_data/devices/${d}.yml`);
              const rr = await r.text();
              data = JSON.parse(window.localStorage.getItem("data"));
              data[d] = YAML.parse(rr);
              window.localStorage.setItem("data", JSON.stringify(data));
            } else {
              for (let m of activeModels.filter(x=>x.match(new RegExp(`^${d}_variant[0-9].yml`)))) {
                const r = await fetch(`https://raw.githubusercontent.com/LineageOS/lineage_wiki/master/_data/devices/${m}.yml`);
                const rr = await r.text();
                data = JSON.parse(window.localStorage.getItem("data"));
                data[m] = YAML.parse(rr);
                window.localStorage.setItem("data", JSON.stringify(data));
              }
            } 
          }
        }

        console.log(JSON.parse(window.localStorage.getItem('data')))

      })()
    </script>
  </body>
</html>
